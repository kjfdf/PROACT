---
title: "BMR staging EDA"
author: "Ilhan Yoo"
date: "r format(Sys.Date())"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align="center", message=FALSE, warning=FALSE, dpi = 300, dev="tiff")
```

## library loading

```{r}
library(tidyverse)
library(gridExtra)
library(broom)
library(reshape)
```

## load datasets
# bmr: BMR stage dataset
# death: dead subjects dataset (dead subject filtered from survival dataset)
# king_mitos: King and MiToS stage dataset
# alsfrs_r: ALSFRS-R score dataset
# clinical_info: clinical information dataset
```{r}
bmr <- read.csv("stage_bmr.csv")
surv <- read.csv("survival.csv")
death <- surv %>% filter(status==1)
king_mitos <- read.csv("stage_king_mitos.csv") 
alsfrs_r <- read.csv("alsfrs_rev.csv")
clinical_info <- read.csv("PROACT_preprocessed.csv")
```
## merge dataset for analysis
# BMR stage에 대응하는 ALSFRS-R 확인위해 데이터셋 merge ALSFRS-R score dataset and BMR stage dataset
# King, MiToS stage에 대응하는 ALSFRS-R 확인위해 데이터셋 merge ALSFRS-R score dataset and King and MiToS stage dataset
```{r}
alsfrs_bmr <- bmr %>% left_join(alsfrs_r,by=c("SubjectID","feature_delta"))
alsfrs_king_mitos <- king_mitos %>% left_join(alsfrs_r,by=c("SubjectID","feature_delta"))
```

## BMR stage 7인 subject들의 ALSFRS-R score확인 
# BMR stage 7은 사망한 상태이므로 ALSFRS-R score가 있다면 잘못된 데이터이므로 filtering필요
```{r}
alsfrs_bmr %>% filter(bmr_stage==7) %>% group_by(ALSFRS_R_Total) %>% tally()
```

## BMR stage 7인 subject의 ALSFRS-R 9,12,17,34인 경우 1명씩 제외, NA값은 남겨놓음 

```{r}
temp <- alsfrs_bmr %>% filter(bmr_stage==7&!is.na(ALSFRS_R_Total))
alsfrs_bmr1 <- alsfrs_bmr %>% anti_join(temp)
rm(temp)
```
## ALSFRS total score and subscore, which were divided into 3 domains from ALSFRS total score, according to BMR stage
```{r}
alsfrs_bmr1 %>% group_by(bmr_stage) %>% summarise(alsfrs_mean=mean(ALSFRS_R_Total),alsfrs_sd=sd(ALSFRS_R_Total),
                                                 bulbar_mean=mean(bulbar),bulbar_sd=sd(bulbar),
                                                 motor_mean=mean(motor),motor_sd=sd(motor),
                                                 respiratory_mean=mean(respiratory),respiratory_sd=sd(respiratory))
```
## 사망하여 ALSFRS-R이 존재할 수 없는 stage 7를 제외한 나머지 BMR stage와 ALSFRS-R association 확인하는 plot  
```{r}
p_bmr_1 <- alsfrs_bmr1 %>% ggplot(aes(x=factor(bmr_stage),y=ALSFRS_R_Total))+
  geom_boxplot(width=0.8,outlier.size=3,outlier.shape=16,outlier.color = "red")+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  theme_classic()+
  labs(x="BMR stage",y="ALSFRS-R")
```

## King's stage 5인 subject들의 ALSFRS-R score확인 
# King's stage 5는 사망한 상태이므로 ALSFRS-R score가 있다면 잘못된 데이터이므로 filtering필요
```{r}
alsfrs_king_mitos %>% filter(king==5) %>% group_by(ALSFRS_R_Total) %>% tally()
```

## King's stage 5인 subject의 ALSFRS-R 9,12,17,34인 경우 1명씩 제외, NA값은 남겨놓음 
```{r}
temp <- alsfrs_king_mitos %>% filter(king==5&!is.na(ALSFRS_R_Total))
alsfrs_king_mitos1 <- alsfrs_king_mitos %>% anti_join(temp)
rm(temp)
```

## ALSFRS total score and subscore, which were divided into 3 domains from ALSFRS total score, according to King stage
```{r}
alsfrs_king_mitos %>% group_by(king) %>% summarise(alsfrs_mean=mean(ALSFRS_R_Total),alsfrs_sd=sd(ALSFRS_R_Total),
                                                 bulbar_mean=mean(bulbar),bulbar_sd=sd(bulbar),
                                                 motor_mean=mean(motor),motor_sd=sd(motor),
                                                 respiratory_mean=mean(respiratory),respiratory_sd=sd(respiratory))
```

## King's stage-ALSFRS-R plot without King's stage 5
#사망하여 ALSFRS-R이 존재할 수 없는 stage 5를 제외한 나머지 King's stage와 ALSFRS-R association 확인하는 plot
```{r}
p_king_1 <- alsfrs_king_mitos1 %>% ggplot(aes(x=factor(king),y=ALSFRS_R_Total))+
  geom_boxplot(width=0.8,outlier.size=3,outlier.shape=16,outlier.color = "red")+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  theme_classic()+
  coord_cartesian(xlim = c(1,4))+
  labs(x="King's stage",y="ALSFRS-R")
```

## MiToS stage 5인 subject들의 ALSFRS-R score확인 
# MiToS stage 5는 사망한 상태이므로 ALSFRS-R score가 있다면 잘못된 데이터이므로 filtering필요
```{r}
alsfrs_king_mitos %>% filter(mitos==5) %>% group_by(ALSFRS_R_Total) %>% tally()
```

## MiToS stage 5인 subject의 ALSFRS-R 9,12,17,34인 경우 1명씩 제외, NA값은 남겨놓음 
```{r}
temp <- alsfrs_king_mitos %>% filter(king==5&!is.na(ALSFRS_R_Total))
alsfrs_king_mitos1 <- alsfrs_king_mitos %>% anti_join(temp)
rm(temp)
```

## ALSFRS total score and subscore, which were divided into 3 domains from ALSFRS total score, according to MiToS stage
```{r}
alsfrs_king_mitos1 %>% group_by(mitos) %>% summarise(alsfrs_mean=mean(ALSFRS_R_Total),alsfrs_sd=sd(ALSFRS_R_Total),
                                                 bulbar_mean=mean(bulbar),bulbar_sd=sd(bulbar),
                                                 motor_mean=mean(motor),motor_sd=sd(motor),
                                                 respiratory_mean=mean(respiratory),respiratory_sd=sd(respiratory))
```

## MiToS stage-ALSFRS-R plot without MiToS stage 5
#사망하여 ALSFRS-R이 존재할 수 없는 stage 5를 제외한 나머지 MiToS stage와 ALSFRS-R association 확인하는 plot 
```{r}
p_mitos_1 <- alsfrs_king_mitos1 %>% ggplot(aes(x=factor(mitos),y=ALSFRS_R_Total))+
  geom_boxplot(width=0.8,outlier.size=3,outlier.shape=16,outlier.color = "red")+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  theme_classic()+
  coord_cartesian(xlim = c(1,6))+
  labs(x="MiToS stage",y="ALSFRS-R")
```

# BMR stage system이 ALSFRS-R의 변화를 잘 반영하는지를 King's,MiToS stage과 비교하기위해
# BMR,King,MiToS stage plot merge시킴
```{r}
grid.arrange(p_bmr_1,p_king_1,p_mitos_1,ncol=1)
```

## 첫 방문시점의 BMR stage 별 subject수 확인
# BMR stage 0: n=189, 1: n=10546, 2: n=9814, 3: n=6127, 4: n=1723, 5: n=344, 6: n=2
```{r}
p_bmr_2 <- bmr %>% group_by(SubjectID) %>% 
  mutate(first_bmr=first(bmr_stage)) %>%
  ungroup() %>% 
  ggplot(aes(x=first_bmr))+
  geom_bar()+
  coord_cartesian(xlim=c(-1,6))+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="BMR stage at first visit",y="Number of subjects")
```

## 첫 방문시점의 King's stage 별 subject수 확인 
# King's stage 1: n=6878, 2: n=8228, 3: n=6700, 4: n=6939
```{r}
p_king_2 <- king_mitos %>% group_by(SubjectID) %>% 
  mutate(first_king=first(king)) %>%
  ungroup() %>% 
  ggplot(aes(x=first_king))+
  geom_bar()+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="King's stage at first visit",y="Number of subjects")
```



## 첫 방문시점의 MiToS stage 별 subject수 확인 
# MiToS stage 0: n=23354, 1: n=4980, 2: n=380, 3: n=31
```{r}
p_mitos_2 <- king_mitos %>% group_by(SubjectID) %>% 
  mutate(first_mitos=first(mitos)) %>%
  ungroup() %>% 
  ggplot(aes(x=first_mitos))+
  geom_bar()+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  labs(x="MiToS stage at first visit",y="Number of subjects")
```
# 첫방문시점의 BMR, King's, MiToS stage 분포 비교  
```{r}
grid.arrange(p_bmr_2,p_king_2,p_mitos_2)
```

# f/u시점의 ALSFRS변화를 보기위한 환자만 selection: 방문횟수가 2번이상인 환자만 남기고 나머지는 제외
```{r}
temp_bmr <- bmr %>% group_by(SubjectID) %>% 
  mutate(visit=n()) %>% 
  ungroup() %>% 
  filter(visit>=2) %>% 
  left_join(alsfrs_r,by=c("SubjectID","feature_delta"))

temp_king_mitos <- king_mitos %>% group_by(SubjectID) %>% 
  mutate(visit=n()) %>% 
  ungroup() %>% 
  filter(visit>=2) %>% 
  left_join(alsfrs_r,by=c("SubjectID","feature_delta"))
```


# BMR stage에 따른 ALS의 진행에 따른 ALSFRS-R의 변화양상 확인 (ALSFRS-R score가 없는 BMR stage 7는 제외)
```{r}
p_bmr_3 <- temp_bmr %>% filter(bmr_stage<=6) %>% ggplot(aes(feature_delta,ALSFRS_R_Total,col=factor(bmr_stage),group=factor(SubjectID)))+
  geom_line(alpha=0.2)+
  facet_wrap(~bmr_stage,ncol=3,nrow=3)+
  scale_x_continuous(limits=c(0,max(temp_bmr$feature_delta)))+
  scale_color_discrete(name="ALSFRS-R slope per month")+
  labs(x="Visit time (months)")+
  theme_bw()+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())
```



# King's stage에 따른 ALS의 진행에 따른 ALSFRS-R의 변화양상 확인 (ALSFRS-R score가 없는 King's stage 5는 제외) 
```{r}
p_king_3 <- temp_king_mitos %>% filter(king<=4) %>% ggplot(aes(feature_delta,ALSFRS_R_Total,col=factor(king),group=factor(SubjectID)))+
  geom_line(alpha=0.2)+
  facet_wrap(~king,ncol=3,nrow=2)+
  scale_x_continuous(limits=c(0,max(temp_king_mitos$feature_delta)))+
  scale_color_discrete(name="ALSFRS-R slope per month")+
  labs(x="Visit time (months)")+
  theme_bw()+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())
```



# MiToS stage에 따른 ALS의 진행에 따른 ALSFRS-R의 변화양상 확인 (ALSFRS-R score가 없는 MiToS stage 5는 제외) 
```{r}
p_mitos_3 <- temp_king_mitos %>% filter(mitos<=4) %>% ggplot(aes(feature_delta,ALSFRS_R_Total,col=factor(mitos),group=factor(SubjectID)))+
  geom_line(alpha=0.2)+
  facet_wrap(~mitos,ncol=3,nrow=2)+
  scale_x_continuous(limits=c(0,max(temp_king_mitos$feature_delta)))+
  scale_color_discrete(name="ALSFRS-R slope per month")+
  labs(x="Visit time (months)")+
  theme_bw()+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())
```

# BMR stage가 stage가 더 높을수록 ALSFRS-R의 감소속도가 더 빠른지 확인하고 King, MiToS stage과 병의 진행을 잘 반영하는지 비교하기 위해 plot들을 merge하여 
```{r fig.height=10}
grid.arrange(p_bmr_3,p_king_3,p_mitos_3)
```

# exclude patients with only one record and merge the ALSFRS-R score to each subject at each visit time 
```{r}
temp_bmr <- bmr %>% group_by(SubjectID) %>% 
  mutate(visit=n(),first_bmr=first(bmr_stage)) %>% 
  ungroup() %>% 
  filter(visit>=2)
temp_king_mitos <- king_mitos %>% group_by(SubjectID) %>% 
  mutate(visit=n(),first_king=first(king),first_mitos=first(mitos)) %>% 
  ungroup() %>% 
  filter(visit>=2) 
```



# ALS가 악화됨에 따라서 BMR stage가 증가하는지와 증가속도 확인
```{r}
p_bmr_4 <- temp_bmr %>% filter(bmr_stage<=6) %>% ggplot(aes(feature_delta,bmr_stage,col=factor(first_bmr),group=factor(SubjectID)))+
  geom_line(alpha=0.2)+
  facet_wrap(~factor(first_bmr),ncol=2,nrow=3)+
  labs(x="elapsed time from enrollment",y="BMR stage")+
  theme_bw()+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  scale_y_continuous(limits=c(0,8))+
  geom_smooth(method=lm) 
```



# ALS가 악화됨에 따라서 King's stage가 증가하는지와 증가속도 확인
```{r}
p_king_4 <- temp_king_mitos %>% filter(king<=5) %>% ggplot(aes(feature_delta,king,col=factor(first_king),group=factor(SubjectID)))+
  geom_line(alpha=0.2)+
  facet_wrap(~factor(first_king),ncol=2,nrow=2)+
  labs(x="elapsed time from enrollment",y="King's stage")+
  theme_bw()+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  scale_y_continuous(limits=c(0,5))+
  geom_smooth(method=lm) 
```



# ALS가 악화됨에 따라서 MiToS stage가 증가하는지와 증가속도 확인
```{r}
p_mitos_4 <- temp_king_mitos %>% filter(mitos<=5) %>% ggplot(aes(feature_delta,mitos,col=factor(first_mitos),group=factor(SubjectID)))+
  geom_line(alpha=0.2)+
  facet_wrap(~factor(first_mitos),ncol=2,nrow=2)+
  labs(x="elapsed time from enrollment",y="MiToS stage")+
  theme_bw()+
  theme(legend.position = "none",panel.grid.major = element_blank(),panel.grid.minor = element_blank())+
  scale_y_continuous(limits=c(0,5))+
  geom_smooth(method=lm) 
```

# BMR stage가 ALS악화를 잘 반영하는지를 King,MiToS stage와 비교
```{r fig.height=10}
grid.arrange(p_bmr_4,p_king_4,p_mitos_4)
```

# distribution of ALS stage last recorded in 12 month period by baseline stage, exclude patients with fu period of less than 9 months 
# bmr_feature_delta_12mo, king_mitos_feature_delta_12mo: f/u data가 9~15개월의 데이터가 있는 대상자만 filtering
```{r}
bmr_feature_delta_12mo <- bmr %>% group_by(SubjectID) %>% 
  mutate(first_bmr=first(bmr_stage)) %>% 
  ungroup() %>% 
  filter(between(feature_delta,9,15))
king_mitos_feature_delta_12mo <- king_mitos %>% group_by(SubjectID) %>% 
  mutate(first_king=first(king),first_mitos=first(mitos)) %>%
  ungroup() %>% 
  filter(between(feature_delta,9,15))
```



# bmr_feature_delta_12mo, king_mitos_feature_delta_12mo: f/u data 9~15개월의 데이터 중 12개월에 가장 근접한 데이터만 추출 
```{r}
bmr_feature_delta_12mo <- bmr_feature_delta_12mo %>% group_by(SubjectID) %>% 
  mutate(temp_feat=abs(feature_delta-12)) %>% 
  filter(temp_feat==min(temp_feat)) %>% 
  dplyr::select(-temp_feat)
king_mitos_feature_delta_12mo <- king_mitos_feature_delta_12mo %>% group_by(SubjectID) %>% 
  mutate(temp_feat=abs(feature_delta-12)) %>% 
  filter(temp_feat==min(temp_feat)) %>% 
  dplyr::select(-temp_feat)
```



# baseline stage에 따라서 12개월쯤(9~15개월 사이 f/u데이터 중 12개월에 가장 근접한 f/u 시점)의 stage변화 확인
```{r}
p_bmr_5 <- bmr_feature_delta_12mo %>% ggplot(aes(x=factor(first_bmr),fill=factor(bmr_stage)))+
  geom_bar(position="dodge")+
  theme_bw()+
  labs(title="distribution of BMR stage after 12 months",x="Baseline BMR stage",y="Number of subject",fill="BMR stage after \n about 12 months")+
  guides(fill=guide_legend(ncol=2))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),plot.title = element_text(hjust = 0.5))
p_king_5 <-king_mitos_feature_delta_12mo %>% ggplot(aes(x=factor(first_king),fill=factor(king)))+
  geom_bar(position="dodge")+
  theme_bw()+
  labs(title="distribution of King's stage after 12 months",x="Baseline King's stage",y="Number of subject",fill="King's stage after \n about 12 months")+
  guides(fill=guide_legend(ncol=2))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),plot.title = element_text(hjust = 0.5))
p_mitos_5 <-king_mitos_feature_delta_12mo %>% ggplot(aes(x=factor(first_mitos),fill=factor(mitos)))+
  geom_bar(position="dodge")+
  theme_bw()+
  labs(title="distribution of MiToS stage after 12 months",x="Baseline MiToS stage",y="Number of subject",fill="MiToS stage after \n about 12 months")+
  guides(fill=guide_legend(ncol=2))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),plot.title = element_text(hjust = 0.5))
```

# BMR stage의 12개월 지난 시점의 stage변화 분포를 확인하고 King,MiToS와 비교
```{r fig.height=10}
grid.arrange(p_bmr_5,p_king_5,p_mitos_5)
```

# clinical info정보 import, onset으로부터 경과시간 계산 
```{r}
bmr_death <- alsfrs_bmr %>% filter(SubjectID %in% death$SubjectID) %>% merge(clinical_info, all.x = T, by="SubjectID")
bmr_death <- bmr_death %>% mutate(time_from_onset=round(abs(onset_delta)/30,2)+feature_delta,
                                        time_from_diag=round(abs(diag_delta)/30,2)+feature_delta)
king_mitos_death <- king_mitos %>% filter(SubjectID %in% death$SubjectID) %>% merge(clinical_info, all.x = T, by="SubjectID")
king_mitos_death <- king_mitos_death %>% mutate(time_from_onset=round(abs(onset_delta)/30,2)+feature_delta,
                                        time_from_diag=round(abs(diag_delta)/30,2)+feature_delta)
```



# standardised time 계산
# 사망한상태인 경우 사망시점은 무조건 standardised time이 1이어야 하나 1미만의 수치를 보이는 케이스는 제외함.
```{r}
bmr_death <- bmr_death %>% group_by(SubjectID) %>% 
  mutate(stan_time=time_from_onset/max(time_from_onset)) %>% 
  arrange(SubjectID,feature_delta)
temp <- bmr_death %>% filter(bmr_stage==7&stan_time<1)
bmr_death <- setdiff(bmr_death,temp)

king_mitos_death <- king_mitos_death %>% group_by(SubjectID) %>% 
  mutate(stan_time=time_from_onset/max(time_from_onset)) %>% 
  arrange(SubjectID,feature_delta)
temp <- king_mitos_death %>% filter(king==5&stan_time<1)
king_mitos_death <- setdiff(king_mitos_death,temp)
```



# standardised time plot, subject별로 BMR stage내에서 stage변하기 직전의 time from onset으로 standardized time계산
# 예를 들면 time from onset 7,20,30에 stage가 3이고 time from onset 40에 stage가 4이면 stage 3의 median time은 30으로 간주함
# BMR stage가 증가함에 따라 standardised time이 증가하여 1에 점점 가까워 지는지 분포확인
# 질병이 진행한다면 점점 사망에 가까워져야 하고 간격이 균일해야  이상적인 분포임.
# BMR과의 비교를 위해 King,MiToS의 standardised time도 
```{r}
p_bmr_6 <- bmr_death %>% group_by(SubjectID,bmr_stage) %>% 
  filter(feature_delta==max(feature_delta)) %>% 
  ungroup() %>% 
  ggplot(aes(factor(bmr_stage),stan_time,fill=factor(bmr_stage)))+
  geom_boxplot()+
  theme(panel.grid = element_blank())+
  coord_flip()+
  labs(x="BMR stage",y="Standardized median time",fill="BMR stage")
p_king_6 <- king_mitos_death %>% group_by(SubjectID,king) %>% 
  filter(feature_delta==max(feature_delta)) %>% 
  ungroup() %>% 
  ggplot(aes(factor(king),stan_time,fill=factor(king)))+
  geom_boxplot()+
  theme(panel.grid = element_blank())+
  coord_flip()+
  labs(x="King's stage",y="Standardized median time",fill="King's stage")
p_mitos_6 <- king_mitos_death %>% group_by(SubjectID,mitos) %>% 
  filter(feature_delta==max(feature_delta)) %>% 
  ungroup() %>% 
  ggplot(aes(factor(mitos),stan_time,fill=factor(mitos)))+
  geom_boxplot()+
  theme(panel.grid = element_blank())+
  coord_flip()+
  labs(x="MiToS stage",y="Standardized median time",fill="MiToS stage")
```

# BMR stage의 장점을 보기위해 기존의 King, MiToS의 standardised time과도 비교
```{r fig.height=10}
grid.arrange(p_bmr_6,p_king_6,p_mitos_6)
```

# bmr_tran: SubjectId별로 grouping하여 이전시점과 다음 방문 시점의 BMR stage를 비교하고 transition probability 계산
# king_tran, mitos_tran: SubjectId별로 grouping하여 이전시점과 다음 방문 시점의 King's,MiToS stage의 진행확률인 transition probability 계산
```{r}
bmr_tran <- bmr %>% group_by(SubjectID) %>% 
  mutate(bmr_stage_next=lead(bmr_stage)) %>% 
  filter(!is.na(bmr_stage_next))
bmr_tran_mtrx_prop <- prop.table(table(bmr_tran$bmr_stage_next,bmr_tran$bmr_stage),2)

king_tran <- king_mitos %>% group_by(SubjectID) %>% 
  mutate(king_stage_next=lead(king)) %>% 
  filter(!is.na(king_stage_next))
king_tran_mtrx_prop <- prop.table(table(king_tran$king_stage_next,king_tran$king),2)

mitos_tran <- king_mitos %>% group_by(SubjectID) %>% 
  mutate(mitos_stage_next=lead(mitos)) %>% 
  filter(!is.na(mitos_stage_next))
mitos_tran_mtrx_prop <- prop.table(table(mitos_tran$mitos_stage_next,mitos_tran$mitos),2)
```



# confusion matrix plot을 구하기위해 transition probability 데이터 형태를 매트릭스에서 dataframe형태로 변경
```{r}
bmr_tran_mtrx_prop1 <- melt(bmr_tran_mtrx_prop)
king_tran_mtrx_prop1 <- melt(king_tran_mtrx_prop)
mitos_tran_mtrx_prop1 <- melt(mitos_tran_mtrx_prop)
```



# 각 stage system별로 transition probability plot 구함.
```{r}
p_bmr_7 <- bmr_tran_mtrx_prop1 %>% ggplot(aes(x=Var.2,y=Var.1,fill=value))+
  geom_raster()+
  geom_text(aes(label=round(value,2)))+ 
  labs(x="BMR stage",y="BMR stage of next visit",fill="Transition probability")+
  scale_fill_viridis_c()+
  scale_x_continuous(breaks=seq(0,6,by=1))+
  scale_y_continuous(breaks=seq(0,7,by=1))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p_king_7 <- king_tran_mtrx_prop1 %>% ggplot(aes(x=Var.2,y=Var.1,fill=value))+
  geom_raster()+
  geom_text(aes(label=round(value,2)))+ 
  labs(x="King's stage",y="King's stage of next visit",fill="Transition probability")+
  scale_fill_viridis_c()+
  scale_x_continuous(breaks=seq(0,4,by=1))+
  scale_y_continuous(breaks=seq(0,5,by=1))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p_mitos_7 <- mitos_tran_mtrx_prop1 %>% ggplot(aes(x=Var.2,y=Var.1,fill=value))+
  geom_raster()+
  geom_text(aes(label=round(value,2)))+ 
  labs(x="MiToS stage",y="MiToS stage of next visit",fill="Transition probability")+
  scale_fill_viridis_c()+
  scale_x_continuous(breaks=seq(0,4,by=1))+
  scale_y_continuous(breaks=seq(0,5,by=1))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
```

# BMR stage의 transition probability를 King,MiToS stage system과 비교
```{r fig.height=10}
grid.arrange(p_bmr_7,p_king_7,p_mitos_7)
```
