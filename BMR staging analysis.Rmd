---
title: "BMR staging"
subtitle: "version 1.0"
author: "유일한"
date: "'r format(Sys.Date())'"
output: 
  word_document:
    fig_height: 4
    fig_width: 4
    toc: no
    reference_docx: template.docx
  pdf_document:
    fig_height: 6
    fig_width: 10
    toc: no
  html_document:
    fig_height: 6
    fig_width: 10
    highlight: textmate
    theme: cosmo
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.aligh="center", message = F, warning = F,fig.height = 4, cache=T, dpi=300, dev="tiff")
```

# 필요한 library로딩

```{r echo=F}
library(tidyverse)
library(dlookr)
library(broom)
library(gridExtra)
library(data.table)
library(knitr)
library(writexl)
library(lubridate)
library(gmodels)
library(moonBook)
library(survival)
library(survminer)
library(epiDisplay)
options("scipen"=100)
options(max.print=1000000)
```
# BMR stage data set
```{r}
bmr <- read.csv("stage_bmr.csv")
```
# ALSFRS-R score dataset
```{r}
alsfrs_r <- read.csv("alsfrs_rev.csv")
```
# merge ALSFRS-R score dataset and BMR stage dataset
```{r}
alsfrs_bmr <- bmr %>% left_join(alsfrs_r,by=c("SubjectID","feature_delta"))
```
# # characteristics of each stage
# distribution of ALSFRS-R total and domain scores at each stage
```{r}
alsfrs_bmr %>% group_by(bmr_stage) %>% summarise(alsfrs_mean=mean(ALSFRS_R_Total),alsfrs_sd=sd(ALSFRS_R_Total),
                                                 bulbar_mean=mean(bulbar),bulbar_sd=sd(bulbar),
                                                 motor_mean=mean(motor),motor_sd=sd(motor),
                                                 respiratory_mean=mean(respiratory),respiratory_sd=sd(respiratory))
p_alsfrs <- alsfrs_bmr %>% ggplot(aes(x=factor(bmr_stage),y=ALSFRS_R_Total))+
  geom_boxplot(width=0.8,outlier.size=3,outlier.shape=16,outlier.color = "red")+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(x="BMR stage",y="ALSFRS-R")
p_bulbar <- alsfrs_bmr %>% ggplot(aes(x=factor(bmr_stage),y=bulbar))+
  geom_boxplot(width=0.8,outlier.size=3,outlier.shape=16,outlier.color = "red")+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(x="BMR stage",y="ALSFRS-R bulbar subscore")
p_motor <- alsfrs_bmr %>% ggplot(aes(x=factor(bmr_stage),y=motor))+
  geom_boxplot(width=0.8,outlier.size=3,outlier.shape=16,outlier.color = "red")+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(x="BMR stage",y="ALSFRS-R motor subscore")
p_respiratory <- alsfrs_bmr %>% ggplot(aes(x=factor(bmr_stage),y=respiratory))+
  geom_boxplot(width=0.8,outlier.size=3,outlier.shape=16,outlier.color = "red")+
  theme(plot.title = element_text(hjust = 0.5))+
  labs(x="BMR stage",y="ALSFRS-R respiratory subscore")
grid.arrange(p_alsfrs,p_bulbar,p_motor,p_respiratory,nrow=2,ncol=2)
```
# at what stages are patients enrolled? 
```{r}
enroll_stage_bmr <- alsfrs_bmr %>% filter(feature_delta==first(feature_delta)) %>% 
  ggplot(aes(bmr_stage))+
  geom_bar()+
  labs(x="BMR stage",y="number of subjects")+
  scale_x_continuous(breaks = seq(0,7))+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
enroll_stage_bmr
```
# estimate the slope of ALSFRS-R total score within each stage (using linear regression), and then compare the slope of ALSFRS-R total score across stages 
```{r}
alsfrs_slope_bmr <- alsfrs_bmr %>% ggplot(aes(x=bmr_stage,y=ALSFRS_R_Total))+
  stat_summary(fun.data = mean_cl_normal)+
  geom_smooth(method='lm',formula = y~x)+
  labs(x="BMR stage",y="ALSFRS-R")+
  scale_x_continuous(breaks = seq(0,7))+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
alsfrs_slope_bmr
```
# Changes of stages with disease progression 
```{r}
alsfrs_bmr %>% group_by(SubjectID) %>% ggplot(aes(x=ALSFRS_R_Total,y=bmr_stage,col(first(bmr_stage))))+
  stat_summary(fun.data = mean_cl_normal)+
  geom_smooth(method='lm',formula = y~x)+
  labs(x="ALSFRS-R",y="BMR stage")+
  scale_x_continuous(breaks = seq(0,48,by=6))+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
```

